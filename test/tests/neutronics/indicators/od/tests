[Tests]
  issues = '#1028 #1106'
  design = 'ElementOpticalDepthIndicator.md'

  [all_h]
    type = Exodiff
    input = 'openmc.i'
    exodiff = 'openmc_out.e'
    requirement = 'The system shall allow for the calculation of the optical depth using the min/max vertex separation or the cube root of the element volume.'
    mesh_mode = 'replicated'
    capabilities = 'openmc'
  []
  [invert_all_h]
    type = Exodiff
    input = 'openmc.i'
    exodiff = 'openmc_inv_out.e'
    cli_args = 'Adaptivity/Indicators/optical_depth_hmin/invert=true Adaptivity/Indicators/optical_depth_hmax/invert=true Adaptivity/Indicators/optical_depth_cuberoot/invert=true Outputs/file_base="openmc_inv_out"'
    requirement = 'The system shall allow for the calculation of the inverse optical depth using the min/max vertex separation or the cube root of the element volume.'
    mesh_mode = 'replicated'
    capabilities = 'openmc'
  []
  [not_rxn_rate]
    type = RunException
    input = 'openmc.i'
    cli_args = 'Adaptivity/Indicators/optical_depth_hmin/rxn_rate=kappa_fission'
    requirement = 'The system shall error if a non-reaction rate score is provided to ElementOpticalDepthIndicator.'
    expect_err = 'At present the ElementOpticalDepthIndicator only works with reaction rate scores. kappa_fission is not a valid reaction rate score.'
    mesh_mode = 'replicated'
    capabilities = 'openmc'
  []
  [missing_score]
    type = RunException
    input = 'openmc.i'
    cli_args = 'Adaptivity/Indicators/optical_depth_hmin/rxn_rate=fission'
    requirement = 'The system shall error if a a reaction rate score is requested, but not available in a tally.'
    expect_err = 'The problem does not contain any score named fission!'
    mesh_mode = 'replicated'
    capabilities = 'openmc'
  []
  [missing_flux]
    type = RunException
    input = 'openmc.i'
    cli_args = 'Problem/Tallies/Mesh/score="kappa_fission total"'
    requirement = 'The system shall error if the flux is not available in a tally.'
    expect_err = 'In order to use an ElementOpticalDepthIndicator one of your'
    mesh_mode = 'replicated'
    capabilities = 'openmc'
  []
  [duplicate_scores]
    type = CSVDiff
    input = openmc_dup.i
    csvdiff = openmc_dup_out.csv
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='Mesh' Adaptivity/Indicators/optical_depth_cuberoot/flux_tally='Mesh'"
    requirement = "The system shall allow for the computation of optical depth indicators "
                  "when multiple tallies are added which accumulate the same scores."
    capabilities = 'openmc'
  []
  [duplicate_scores_rxn_tally_not_provided]
    type = RunException
    input = openmc_dup.i
    requirement = "The system shall error if two tallies accumulate the same reaction rate scores and the user doesn't "
                  "select one to use for computing optical depths."
    expect_err = "When adding more then one tally with total in the \[Tallies\] block, the 'rxn_rate_tally' parameter is required!"
    capabilities = 'openmc'
  []
  [duplicate_scores_flux_tally_not_provided]
    type = RunException
    input = openmc_dup.i
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='Mesh'"
    requirement = "The system shall error if two tallies accumulate flux scores and the user doesn't "
                  "select one to use for computing optical depths."
    expect_err = "When adding more then one tally with flux in the \[Tallies\] block, the 'flux_tally' parameter is required!"
    capabilities = 'openmc'
  []
  [duplicate_scores_missing_rxn_rate_tally]
    type = RunException
    input = openmc_dup.i
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='na'"
    requirement = "The system shall error if the user provides a non-existent reaction rate tally."
    expect_err = "This tally does not exist"
    capabilities = 'openmc'
  []
  [duplicate_scores_missing_flux_tally]
    type = RunException
    input = openmc_dup.i
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='Mesh' Adaptivity/Indicators/optical_depth_cuberoot/flux_tally='na'"
    requirement = "The system shall error if the user provides a non-existent flux tally."
    expect_err = "This tally does not exist"
    capabilities = 'openmc'
  []
  [duplicate_scores_tally_has_no_rxn_rate]
    type = RunException
    input = openmc_dup.i
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='Cell_2'"
    requirement = "The system shall error if the user provides a reaction rate tally that does not accumulate the requested reaction rate."
    expect_err = "This tally does not score total!"
    capabilities = 'openmc'
  []
  [duplicate_scores_tally_has_no_flux]
    type = RunException
    input = openmc_dup.i
    cli_args = "Adaptivity/Indicators/optical_depth_cuberoot/rxn_rate_tally='Mesh' Adaptivity/Indicators/optical_depth_cuberoot/flux_tally='Cell_2'"
    requirement = "The system shall error if the user provides a flux tally that does not accumulate flux."
    expect_err = "This tally does not score flux!"
    capabilities = 'openmc'
  []
[]
